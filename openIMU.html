<!DOCTYPE html>
<html lang="en">
    <head>
        <title>OpenIMU - CrowForce</title>
        <link rel="stylesheet" href="index.css">
        <link rel="stylesheet" href="assets/prism/prism.css">
        <script src="assets/prism/prism.js"></script>
        <style>
            img.DriverHubScreen {
                height: 10lh;
                width: auto;
                margin-top: 0;
            }
        </style>
    </head>

    <div class="openimu">
        <div class="nav">
            <a href="index.html">Home</a>
            <a href="hardware.html">Hardware</a>
            <a href="software.html">Software</a>
            <a id="currentpage" href="#">OpenIMU</a>
            <a href="https://crowforce10809.wixsite.com/ftc-robotics" target="_blank">Business Website</a>
        </div>

        <div class="header">
            <h1>OpenIMU</h1>
        </div>

        <div class="block">
            <h1>Background</h1>

            <h2>The Problem</h2>
            <p>Over our first three competitions, team 10809 CrowForce sacrificed points during autonomous and tele-op when our robot became disoriented, causing failures in autonomous trajectory sequences and field-centric driver control. These failures seemed to coincide with collisions between exposed metal on our robot and other metalic objects on the field such as the 2023-'24 CENTERSTAGE™ game's truss supports and other robots.</p>

            <p>By finding a way to reproduce failures with truss contact and then printing Inertial Measurement Unit (IMU) orientation telemetry to the driver hub, we observed our gyroscope and accelerometer readings drop to all zeros after metal contact that would persist until repowering the robot. We learned that these IMU flatlines resulted from electrostatic discharge (also known as ESD); See <a href="https://ftc-docs.firstinspires.org/en/latest/hardware_and_software_configuration/configuring/managing_esd/managing-esd.html">FIRST's article “Managing Electrostatic Discharge Effects”</a> to learn more. Our investigation lead us to suspect that the hardware changes to <a href="https://www.revrobotics.com/rev-31-1595/">REV Robotics' REV-31-1595 Control Hubs</a> made after December 1st 2021 left those newer control hubs more succeptible to ESD events (this change coincided with the <a href="https://www.revrobotics.com/blog/expansion-hub-IMU-updates">removal of IMUs from new expansion hubs</a>). We tested this hypothesis by switching our robot's control hub with an older model and observing a reduction in IMU resets. Unfortunately, older generation control hubs are a luxury of established teams and they won't survive the playfield forever.</p>

            <p><strong>Note:</strong> To determine which type of IMU your control hub contains without knowing its manufacture date, see the control hub's web interface as explained by <a href="https://docs.revrobotics.com/duo-control/sensors/i2c/imu#how-to-use">REV's IMU documentation</a>.</p>

            <hr>
            <h2>Our Solution</h2>
            <p>Once your team has applied FIRST's suggestions for mitigating static, such as adding a resistive grounding strap and shielding exposed metal surfaces with electrically insulating material, your new control hub's IMU may <em>still</em> reset when shocked.</p>

            <p>Fortunately, external IMU sensor boards using the same chip as original control hubs can still be purchased! Read on for a simple guide to buying, assembling, attaching, and configuring a replacement IMU in a 3D-printed enclosure designed by team 10809 CrowForce and the mentors of Sage Creek High School.</p>
        </div>

        <div class="block">
            <h1>Hardware</h1>

            <h2>Some Assembly Required</h2>
            <p>To build the OpenIMU, you will need some base knowledge on/with:</p>
            <ul>
                <li>Soldering</li>
                <li>General Hardware Assembly</li>
                <li>3D Printing and Post-Processing Prints</li>
            </ul>

            <hr>
            <h2>Assembly Instructions:</h2>
            <p>WIP, coming soon :)</p>
        </div>

        <div class="block">
            <h1>Software</h1>

            <h2>Driver Station</h2>
            <p>It is very easy to get your external IMU to talk to your robot controller. Below are instructions on how to configure the external IMU using your connected driver station.</p>
            <hr>

            <h3>Disable Internal IMU</h3>
            <p>First, disable the built-in internal IMUs from your control hub using a connected driver station:</p>
            <ol>
                <li>
                    <p>At the driver station's main screen, tap the three-dots button at the top right and select “Configure Robot”.</p>

                    <img class="DriverHubScreen" src="assets/images/DriverStation1.png" alt="The Driver Station's “Robot Configuration” screen listing two available configurations for editing: “2023_2024” and “camera”.">
                </li>
                <li>
                    <p>Tap the “Edit” button of your existing robot configuration.</p>

                    <img class="DriverHubScreen" src="assets/images/DriverStation2.png" alt="The Driver Station's “Robot Configuration” screen after opening the “2023_2024” configuration for editing. Two USB devices are listed for this configuration: “Webcam 1” and “Control Hub Portal”.">
                </li>
                <li>
                    <p>Tap the “Control Hub Portal” within your robot configuration to see its connected control and expansion hubs.</p>

                    <img class="DriverHubScreen" src="assets/images/DriverStation3.png" alt="The Driver Station's “Robot Configuration” screen after selecting the USB device named “Control Hub Portal”. Two contained devices are listed: “Expansion Hub 2” and “Control Hub”.">
                </li>
                <li>
                    <p>Tap “Control Hub” to view categories of connected peripherals.</p>

                    <img class="DriverHubScreen" src="assets/images/DriverStation4.png" alt="The Driver Station's “Robot Configuration” screen after selecting the “Control Hub” entry within “Control Hub Portal”. The first five visible categories of connected peripherals are “Analog Input Devices”, “I2C Bus 0”, “I2C Bus 1”, “I2C Bus 2”, and “I2C Bus 3”.">
                </li>
                <li>
                    <p>Tap “I2C Bus 0” to configure sensors connected to the first communications channel. The control hub's internal IMU is hardwired to this I2C bus.</p>
                </li>
                <li>
                    <p>Look for any entries of “REV Control Hub IMU” and disable them by selecting “Nothing”.</p>

                    <p><strong>Note:</strong> <em>Do not</em> add your external IMU on this I2C bus, since the unified <code>IMU</code> interface code for reading measurements will ignore your configuration and try to talk to the original internal IMU instead. See the next section for adding your external IMU to a different I2C bus.</p>

                    <img class="DriverHubScreen" src="assets/images/DriverStation5.png" alt="The Driver Station's “Robot Configuration” screen after selecting “I2C Bus 0” within “Control Hub”. In the two-column table of port numbers and associated attached I2C devices, port zero has been assigned the device type “Nothing”.">
                </li>
            </ol>

            <h3>Add External IMU</h3>
            <p>Second, add the new external IMU to a control or expansion hub:</p>
            <ol>
                <li>
                    <p>Now go to I2C Bus 1 and add an “Adafruit IMU”.</p>

                    <img class="DriverHubScreen" src="assets/images/DriverStation6.png" alt="The Driver Station's “Robot Configuration” screen after returning to the previous “Control Hub” screen and selecting “I2C Bus 1” instead. Port zero has been assigned the device type “Adafruit IMU”.">
                </li>
                <li>
                    <p>Name your external Adafruit IMU sensor to match how your code gets a reference to it (such as using <code class="language-java">hardwareMap.get</code> in Java). In the next section's code sample, we will use the name “<kbd>imu</kbd>”.</p>

                    <img class="DriverHubScreen" src="assets/images/DriverStation7.png" alt="The Driver Station's “Robot Configuration” screen after renaming the “Adafruit IMU” device on port zero of “I2C Bus 1” to “imu”.">
                </li>
            </ol>

            <hr>
            <h2>Code</h2>
            <p>The code below shows how to setup your new IMU. Make the name of your imu matches the name in IC Bus 2 slot on your drive hub. Another thing to note is the Orientation we have given about our IMU. This changes depending on how you have your external IMU positioned.</p>

            <pre><code class="language-java">package org.firstinspires.ftc.teamcode;

import com.qualcomm.hardware.rev.RevHubOrientationOnRobot;
import com.qualcomm.robotcore.eventloop.opmode.LinearOpMode;
import com.qualcomm.robotcore.eventloop.opmode.TeleOp;
import com.qualcomm.robotcore.hardware.IMU;

import org.firstinspires.ftc.robotcore.external.navigation.AngleUnit;
import org.firstinspires.ftc.robotcore.external.navigation.AxesOrder;
import org.firstinspires.ftc.robotcore.external.navigation.AxesReference;


@TeleOp(name = "External IMU Test", group = "Teleop")
public class ExternalIMU extends LinearOpMode {
    public IMU imu;

    public void runOpMode() throws InterruptedException {
        //Set up external IMU from I2C bus 1
        imu = hardwareMap.get(IMU.class, "imu");
        IMU.Parameters imuParameters;

        //Parameters for IMU
        imuParameters = new IMU.Parameters(
            new RevHubOrientationOnRobot(
                //The OpenIMU holds its external IMU in the same orientation as
                //an internal IMU, so you can copy your original values here.
                RevHubOrientationOnRobot.LogoFacingDirection.UP,
                RevHubOrientationOnRobot.UsbFacingDirection.BACKWARD
            )
        );

        imu.initialize(imuParameters);

        //Reset left-to-right rotation
        imu.resetYaw();

        waitForStart();
        while (opModeIsActive()) {
            telemetry.addData("🧭 IMU Rotation (degrees)", getAngle());
            telemetry.update();
        }
    }

    public double getAngle() {
        return imu.getRobotOrientation(AxesReference.EXTRINSIC, AxesOrder.ZYX,
            AngleUnit.DEGREES).firstAngle;
    }
}
</code></pre>
        </div>


        <div class="footer">
            <a href="https://github.com/CrowForce" target="_blank">Github</a> | <a href="https://crowforce10809.wixsite.com/ftc-robotics" target="_blank">Buisness Website</a>
        </div>
    </div>
</html>
